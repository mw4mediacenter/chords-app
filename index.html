<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Chords (Piano)</title>
  <style>
    :root{
      --bg:#f2f2f7;
      --panel:#ffffff;
      --text:#0b0b0f;
      --muted:#6b6b78;
      --line:#e5e5ea;
      --blue:#0a84ff;
      --bubble:#f6b332;
      --bubbleText:#1b1b1f;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius:16px;
    }
    [data-theme="dark"]{
      --bg:#0b0b10;
      --panel:#14141a;
      --text:#f3f3f7;
      --muted:#a0a0ad;
      --line:#2a2a34;
      --blue:#4aa3ff;
      --shadow: 0 10px 26px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px 8px;
      gap:10px;
      position:sticky;
      top:0;
      background:linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0)) , var(--bg);
      z-index:10;
    }
    .title{
      font-weight:800;
      font-size:28px;
      letter-spacing:-.02em;
    }
    .tabs{
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px;
      box-shadow: var(--shadow);
    }
    .tab{
      border:0;
      background:transparent;
      padding:8px 14px;
      border-radius:999px;
      font-weight:700;
      color:var(--muted);
      cursor:pointer;
    }
    .tab.active{
      background:rgba(10,132,255,.12);
      color:var(--blue);
    }
    .actions{
      display:flex; align-items:center; gap:8px;
    }
    .iconBtn{
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel);
      box-shadow: var(--shadow);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      color:var(--text);
    }
    .star{
      color:#ffcc00;
      font-size:18px;
      line-height:1;
    }

    .wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      padding:0 12px 12px;
      max-width: 1300px;
      margin: 0 auto;
    }

    /* Responsive: single column on narrow screens */
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .title{font-size:24px}
    }

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .left{
      padding:12px;
    }
    .searchRow{
      display:flex; gap:8px; align-items:center;
    }
    .search{
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.02);
    }
    [data-theme="dark"] .search{ background:rgba(255,255,255,.04); }
    .search input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:16px;
    }
    .pillRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
    }
    .seg{
      display:flex;
      gap:6px;
      background:rgba(0,0,0,.04);
      border:1px solid var(--line);
      padding:4px;
      border-radius:999px;
    }
    [data-theme="dark"] .seg{ background:rgba(255,255,255,.06); }
    .seg button{
      border:0;
      background:transparent;
      padding:7px 12px;
      border-radius:999px;
      font-weight:700;
      color:var(--muted);
      cursor:pointer;
    }
    .seg button.active{
      background:var(--panel);
      color:var(--text);
      border:1px solid var(--line);
    }

    .rootScroller{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .rootLabel{
      font-weight:800;
      font-size:18px;
      width:30px;
      text-align:center;
    }
    .rootTrack{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      gap:10px;
      padding:8px 6px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.02);
      flex:1;
    }
    [data-theme="dark"] .rootTrack{ background:rgba(255,255,255,.04); }
    .rootItem{
      min-width:40px;
      height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel);
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      user-select:none;
    }
    .rootItem.active{ color:var(--blue); background:rgba(10,132,255,.10); border-color:rgba(10,132,255,.25); }

    .list{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: calc(100vh - 250px);
      overflow:auto;
      padding-right:4px;
    }
    @media (max-width: 980px){
      .list{ max-height: 320px; }
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.02);
      cursor:pointer;
    }
    [data-theme="dark"] .row{ background:rgba(255,255,255,.04); }
    .row.active{
      outline:3px solid rgba(10,132,255,.25);
      border-color: rgba(10,132,255,.35);
      background: rgba(10,132,255,.10);
    }
    .row .name{
      font-weight:900;
      font-size:18px;
    }
    .row .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .miniKeys{
      width:130px;
      height:34px;
      border-radius:10px;
      border:1px solid var(--line);
      background:linear-gradient(#fff,#f5f5f8);
      position:relative;
      overflow:hidden;
    }
    [data-theme="dark"] .miniKeys{ background:linear-gradient(#1a1a22,#121218); }
    .miniMark{
      position:absolute;
      bottom:0;
      width:10px;
      border-radius:6px 6px 0 0;
      background: rgba(246,179,50,.85);
    }

    /* Right panel */
    .right{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .headerRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hTitle{
      font-weight:900;
      font-size:26px;
      letter-spacing:-.02em;
    }
    .legacyLine{
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      text-align:right;
      white-space:nowrap;
    }

    .invRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.02);
    }
    [data-theme="dark"] .invRow{ background:rgba(255,255,255,.04); }

    .invBtns{
      display:flex; gap:6px;
      background:rgba(0,0,0,.04);
      border:1px solid var(--line);
      padding:4px;
      border-radius:999px;
    }
    [data-theme="dark"] .invBtns{ background:rgba(255,255,255,.06); }
    .invBtns button{
      border:0; background:transparent;
      padding:7px 12px;
      border-radius:999px;
      font-weight:900;
      color:var(--muted);
      cursor:pointer;
    }
    .invBtns button.active{
      background:var(--panel);
      color:var(--text);
      border:1px solid var(--line);
    }

    .details{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    .dRow{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.01);
    }
    [data-theme="dark"] .dRow{ background: rgba(255,255,255,.03); }
    .dRow:last-child{border-bottom:0}
    .dKey{color:var(--muted); font-weight:800;}
    .dVal{font-weight:900;}

    /* Piano */
    .pianoWrap{
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:var(--panel);
    }
    .pianoTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.01);
    }
    [data-theme="dark"] .pianoTop{ background: rgba(255,255,255,.03); }

    .playMode{
      display:flex;
      gap:8px;
      background:rgba(0,0,0,.04);
      border:1px solid var(--line);
      padding:4px;
      border-radius:999px;
    }
    [data-theme="dark"] .playMode{ background:rgba(255,255,255,.06); }
    .playMode button{
      border:0;background:transparent;
      padding:7px 12px;border-radius:999px;
      font-weight:900;color:var(--muted);cursor:pointer;
    }
    .playMode button.active{
      background:var(--panel);
      color:var(--text);
      border:1px solid var(--line);
    }

    .kbd{
      position:relative;
      width:100%;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      background: linear-gradient(#ffffff, #f2f2f7);
    }
    [data-theme="dark"] .kbd{
      background: linear-gradient(#121218, #0b0b10);
    }
    .kbdInner{
      position:relative;
      height:230px;
      min-width: 940px; /* enables horizontal scrolling instead of breaking layout */
    }
    @media (max-width: 980px){
      .kbdInner{ min-width: 820px; }
    }

    .whiteKey{
      position:absolute; top:0; bottom:0;
      border-left:1px solid rgba(0,0,0,.12);
      border-right:1px solid rgba(0,0,0,.08);
      background: linear-gradient(#ffffff, #f4f4f8);
      border-bottom:4px solid rgba(0,0,0,.10);
      border-radius: 0 0 10px 10px;
    }
    [data-theme="dark"] .whiteKey{
      background: linear-gradient(#f4f4f6, #d8d8de);
    }

    .blackKey{
      position:absolute;
      top:0;
      height:140px;
      border-radius: 0 0 10px 10px;
      background: linear-gradient(#2d2f37, #0a0b10);
      box-shadow:
        inset 0 10px 18px rgba(255,255,255,.10),
        inset 0 -10px 20px rgba(0,0,0,.45);
      z-index:3;
      border:1px solid rgba(255,255,255,.06);
    }

    .keyHit{
      position:absolute; inset:0;
      cursor:pointer;
      background: transparent;
    }

    .bubble{
      position:absolute;
      width:44px; height:44px;
      border-radius:999px;
      background: var(--bubble);
      color: var(--bubbleText);
      font-weight:1000;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:5;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      user-select:none;
      pointer-events:none;
    }

    .bottomBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.01);
    }
    [data-theme="dark"] .bottomBar{ background: rgba(255,255,255,.03); }
    .bigPlay{
      width:56px;height:44px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(10,132,255,.12);
      color:var(--blue);
      font-weight:1000;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }

    .tiny{
      font-size:12px;color:var(--muted);font-weight:800;
    }

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99;
      padding:16px;
    }
    .modal{
      width:min(700px, 100%);
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      font-weight:1000;
    }
    .modalBody{ padding:12px; }
    .favList{ display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto; }
    .favRow{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.02);
      gap:10px;
    }
    [data-theme="dark"] .favRow{ background: rgba(255,255,255,.04); }
    .chk{ width:18px;height:18px; }
    .btn{
      border:1px solid var(--line);
      background:var(--panel);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
    }
    .btn.primary{
      background:rgba(10,132,255,.12);
      color:var(--blue);
      border-color: rgba(10,132,255,.25);
    }
    .rowRight{
      display:flex; align-items:center; gap:8px;
    }
  </style>
</head>

<body data-theme="light">
  <div class="topbar">
    <div class="title">Chords</div>
    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="root">Root</button>
      <button class="tab" data-tab="piano">Piano</button>
      <button class="tab" data-tab="staff">Staff</button>
    </div>
    <div class="actions">
      <button class="iconBtn" id="themeBtn" title="Light/Dark">ðŸŒ“</button>
      <button class="iconBtn" id="favBtn" title="Favorites"><span class="star">â˜…</span></button>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div class="card left">
      <div class="searchRow">
        <div class="search">
          ðŸ”Ž
          <input id="searchInput" placeholder="Search chords (e.g. Cm7, B half diminished, C/7/5-/5+)" autocomplete="off" />
        </div>
        <button class="iconBtn" id="clearBtn" title="Clear">âœ•</button>
      </div>

      <div class="pillRow">
        <div class="seg">
          <button class="active" data-filter="all">All</button>
          <button data-filter="common">Common</button>
          <button data-filter="jazz">Jazz</button>
        </div>
        <div class="tiny" id="leftHint">Type + Enter to search</div>
      </div>

      <div class="rootScroller" id="rootScroller">
        <div class="rootLabel" id="rootLabel">C</div>
        <div class="rootTrack" id="rootTrack"></div>
      </div>

      <div class="list" id="leftList"></div>
    </div>

    <!-- RIGHT -->
    <div class="card right">
      <div class="headerRow">
        <div class="hTitle" id="bigChord">Cm</div>
        <div class="legacyLine" id="legacyLine">Legacy: Cm | Modern: Cm</div>
      </div>

      <div class="invRow">
        <div style="font-weight:1000">Inversion</div>
        <div class="invBtns" id="invBtns">
          <button class="active" data-inv="0">Root</button>
          <button data-inv="1">1st</button>
          <button data-inv="2">2nd</button>
          <button data-inv="3">3rd</button>
        </div>
      </div>

      <div class="details">
        <div class="dRow"><div class="dKey">Degrees</div><div class="dVal" id="degOut">1, â™­3, 5</div></div>
        <div class="dRow"><div class="dKey">Notes</div><div class="dVal" id="notesOut">C, Eâ™­, G</div></div>
        <div class="dRow"><div class="dKey">Mode</div><div class="dVal" id="modeOut">Minor</div></div>
      </div>

      <div class="pianoWrap">
        <div class="pianoTop">
          <div class="tiny" id="kbdTitle">Chord keyboard (single chord)</div>
          <div class="playMode" id="playMode">
            <button class="active" data-play="once">At Once</button>
            <button data-play="asc">Ascending</button>
            <button data-play="desc">Descending</button>
          </div>
        </div>

        <div class="kbd" id="kbd">
          <div class="kbdInner" id="kbdInner"></div>
        </div>

        <div class="bottomBar">
          <button class="bigPlay" id="playBtn">â–¶</button>
          <div class="tiny" id="bottomInfo">Tap keys in Piano tab to detect chords</div>
          <button class="btn" id="toggleFavBtn">â˜… Favorite</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Favorites Modal -->
  <div class="modalBackdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modalHead">
        <div>Favorites</div>
        <div class="rowRight">
          <button class="btn" id="favEditBtn">Edit</button>
          <button class="btn primary" id="favCloseBtn">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="favList" id="favList"></div>
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
          <button class="btn" id="removeSelectedBtn" style="display:none">Remove selected</button>
          <button class="btn" id="removeAllBtn">Remove all</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   THEORY + PARSING
========================= */

const NOTE_NAMES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const NOTE_NAMES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
const ENHARMONIC = {
  "Db":"C#","Eb":"D#","Gb":"F#","Ab":"G#","Bb":"A#",
  "C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","A#":"Bb"
};

function pcFromNoteName(n){
  const norm = n.replace("â™­","b").replace("â™¯","#").trim();
  const up = norm[0].toUpperCase() + norm.slice(1);
  const idxSharp = NOTE_NAMES_SHARP.indexOf(up);
  if (idxSharp >= 0) return idxSharp;
  const idxFlat = NOTE_NAMES_FLAT.indexOf(up);
  if (idxFlat >= 0) return idxFlat;
  return null;
}
function nameFromPc(pc, preferFlats=false){
  pc = (pc%12+12)%12;
  return preferFlats ? NOTE_NAMES_FLAT[pc] : NOTE_NAMES_SHARP[pc];
}
function pretty(n){
  return n.replace("b","â™­").replace("#","â™¯");
}

// Build chord dictionary via formulas (covers a LOT; you can extend easily)
const CHORD_QUALITIES = [
  { id:"maj",  label:"Major",  aliases:["","M","maj"],  degrees:["1","3","5"], intervals:[0,4,7]},
  { id:"min",  label:"Minor",  aliases:["m","min","-"], degrees:["1","â™­3","5"], intervals:[0,3,7]},
  { id:"dim",  label:"Diminished", aliases:["dim","o"], degrees:["1","â™­3","â™­5"], intervals:[0,3,6]},
  { id:"aug",  label:"Augmented", aliases:["aug","+"], degrees:["1","3","â™¯5"], intervals:[0,4,8]},

  { id:"7",    label:"Dominant 7", aliases:["7"], degrees:["1","3","5","â™­7"], intervals:[0,4,7,10]},
  { id:"maj7", label:"Major 7", aliases:["maj7","M7","Î”7"], degrees:["1","3","5","7"], intervals:[0,4,7,11]},
  { id:"m7",   label:"Minor 7", aliases:["m7","min7","-7"], degrees:["1","â™­3","5","â™­7"], intervals:[0,3,7,10]},
  { id:"mMaj7",label:"Minor Maj7", aliases:["mMaj7","mM7","-Î”7"], degrees:["1","â™­3","5","7"], intervals:[0,3,7,11]},
  { id:"dim7", label:"Diminished 7", aliases:["dim7","o7"], degrees:["1","â™­3","â™­5","ð„«7"], intervals:[0,3,6,9]},
  { id:"m7b5", label:"Half diminished", aliases:["m7b5","Ã¸","half diminished","half-diminished","min7b5"], degrees:["1","â™­3","â™­5","â™­7"], intervals:[0,3,6,10]},

  { id:"6",    label:"6", aliases:["6"], degrees:["1","3","5","6"], intervals:[0,4,7,9]},
  { id:"m6",   label:"m6", aliases:["m6","min6"], degrees:["1","â™­3","5","6"], intervals:[0,3,7,9]},
  { id:"9",    label:"9", aliases:["9"], degrees:["1","3","5","â™­7","9"], intervals:[0,4,7,10,14]},
  { id:"maj9", label:"maj9", aliases:["maj9","M9"], degrees:["1","3","5","7","9"], intervals:[0,4,7,11,14]},
  { id:"m9",   label:"m9", aliases:["m9","min9"], degrees:["1","â™­3","5","â™­7","9"], intervals:[0,3,7,10,14]},
  { id:"11",   label:"11", aliases:["11"], degrees:["1","3","5","â™­7","9","11"], intervals:[0,4,7,10,14,17]},
  { id:"13",   label:"13", aliases:["13"], degrees:["1","3","5","â™­7","9","13"], intervals:[0,4,7,10,14,21]},
];

// Quick â€œlegacyâ€ parsing: C/7/5-/5+ , Dm7/9 , Em7/6
function normalizeLegacy(input){
  let s = (input||"").trim();
  if (!s) return "";
  s = s.replaceAll("â™­","b").replaceAll("â™¯","#");
  // legacy separators "/"
  // Examples:
  // C/7/5-/5+  -> C7(b5,#5)
  // Dm7/9      -> Dm9
  // Em7/6      -> Em13? (often m7(add6) ; we map to m6 + b7? We'll map to m7(add6))
  const m = s.match(/^([A-Ga-g])([#b]?)(.*)$/);
  if(!m) return s;
  const root = m[1].toUpperCase()+ (m[2]||"");
  let rest = (m[3]||"").trim();

  if(rest.includes("/")){
    const parts = rest.split("/").filter(Boolean);
    // first token can be like "m7" or "7" or "m"
    let base = parts.shift() || "";
    // if base is just "m" -> minor triad
    // keep as is
    let ext = base;

    // handle cases like m7/9 -> m9
    if (parts.length===1 && parts[0]==="9" && /m7$/.test(ext)) ext = ext.replace(/m7$/,"m9");
    if (parts.length===1 && parts[0]==="9" && /7$/.test(ext) && !/maj7/.test(ext)) ext = ext.replace(/7$/,"9");

    // collect alterations
    const alts = [];
    for(const p of parts){
      if (p==="5-") alts.push("b5");
      else if (p==="5+") alts.push("#5");
      else if (p==="9-") alts.push("b9");
      else if (p==="9+") alts.push("#9");
      else if (p==="11+") alts.push("#11");
      else if (p==="13-") alts.push("b13");
      else if (p==="6" && /m7$/.test(ext)) {
        // Em7/6 -> Em7(add6)
        alts.push("add6");
      } else {
        // fallback: keep token
        alts.push(p);
      }
    }
    if(alts.length){
      // represent in a modern readable way
      // prefer parentheses for alterations
      if(alts.includes("add6")){
        ext = ext + "(add6)";
      } else {
        ext = ext + "(" + alts.join(",") + ")";
      }
    }
    return root + ext;
  }
  return root + rest;
}

// Parse user input into {rootPc, preferFlats, qualityId, customIntervals?, legacyName, modernName}
function parseChordInput(raw){
  const legacyName = (raw||"").trim();
  if(!legacyName) return null;

  const modern = normalizeLegacy(legacyName);

  // Support: "B half diminished"
  const lower = modern.toLowerCase();
  if(lower.includes("half diminished")){
    // e.g. "B half diminished" => Bm7b5
    const r = modern.split(/\s+/)[0];
    return parseChordInput(r+"m7b5");
  }

  // root
  const m = modern.match(/^([A-G])([#b]?)(.*)$/);
  if(!m) return null;
  const rootName = m[1] + (m[2]||"");
  let rest = (m[3]||"").trim();

  let preferFlats = rest.includes("b") || rootName.includes("b");

  // quality detection by aliases (longest first)
  let matchedQuality = null;
  let matchedAlias = "";
  const allAliases = [];
  for(const q of CHORD_QUALITIES){
    for(const a of q.aliases){
      if(a==="") continue;
      allAliases.push({q, a});
    }
  }
  allAliases.sort((x,y)=>y.a.length-x.a.length);

  // Special cases first: m7b5 tokens, Ã¸, etc
  if(rest.startsWith("Ã¸")) { matchedQuality = CHORD_QUALITIES.find(x=>x.id==="m7b5"); matchedAlias="Ã¸"; rest = rest.slice(1).trim(); }
  if(!matchedQuality){
    // try direct known patterns
    for(const {q,a} of allAliases){
      if(rest.toLowerCase().startsWith(a.toLowerCase())){
        matchedQuality=q;
        matchedAlias=a;
        rest = rest.slice(a.length).trim();
        break;
      }
    }
  }
  // default triad if none
  if(!matchedQuality){
    // if rest starts with "m" -> minor, else major
    if(rest.startsWith("m") || rest.startsWith("-")){
      matchedQuality = CHORD_QUALITIES.find(x=>x.id==="min");
      rest = rest.slice(1).trim();
    } else {
      matchedQuality = CHORD_QUALITIES.find(x=>x.id==="maj");
    }
  }

  // Apply alterations in parentheses like (b5,#5) or (add6)
  let intervals = [...matchedQuality.intervals];
  let degrees = [...matchedQuality.degrees];
  const altMatch = modern.match(/\(([^)]+)\)/);
  if(altMatch){
    const alts = altMatch[1].split(",").map(s=>s.trim().toLowerCase());
    for(const a of alts){
      if(a==="b5"){
        // change 5 from 7 to 6
        const idx = intervals.indexOf(7);
        if(idx>=0) intervals[idx]=6;
      }
      if(a==="#5"){
        const idx = intervals.indexOf(7);
        if(idx>=0) intervals[idx]=8;
      }
      if(a==="add6"){
        if(!intervals.includes(9)) intervals.push(9);
      }
    }
    intervals.sort((x,y)=>x-y);
  }

  const rootPc = pcFromNoteName(rootName);
  if(rootPc===null) return null;

  // Compute modern standardized name
  const baseName = pretty(nameFromPc(rootPc, preferFlats));
  let qualName = matchedQuality.aliases[0] || matchedQuality.id; // not perfect but ok
  // Build a cleaner modern suffix:
  const cleanMap = {
    "maj":"", "min":"m", "dim":"dim", "aug":"aug",
    "7":"7","maj7":"maj7","m7":"m7","mMaj7":"mMaj7","dim7":"dim7","m7b5":"m7b5",
    "6":"6","m6":"m6","9":"9","maj9":"maj9","m9":"m9","11":"11","13":"13"
  };
  let suffix = cleanMap[matchedQuality.id] ?? matchedQuality.id;

  // Keep alterations if exist
  let modernName = baseName + suffix;
  if(altMatch){
    modernName += "(" + altMatch[1] + ")";
  }

  return {
    rootPc, preferFlats,
    qualityId: matchedQuality.id,
    qualityLabel: matchedQuality.label,
    intervals, degrees,
    legacyName,
    modernName
  };
}

function chordNotesFromParsed(parsed){
  const pcs = parsed.intervals.map(iv => (parsed.rootPc + (iv%12) + 12) % 12);
  // keep unique
  return [...new Set(pcs)];
}

// Inversion: rotate notes up by octaves (we keep pcs but order changes for playback)
function invertedMidiNotes(parsed, baseMidi=48, inv=0){
  const pcs = chordNotesFromParsed(parsed);
  // build a sorted pitch list near base
  let notes = pcs.slice().sort((a,b)=>a-b).map(pc=>{
    // map pc near baseMidi
    const basePc = baseMidi%12;
    let midi = baseMidi + ((pc - basePc + 12) % 12);
    return midi;
  });
  // ensure ascending
  notes.sort((a,b)=>a-b);

  // apply inversion by moving lowest notes up an octave
  for(let i=0;i<inv;i++){
    if(notes.length===0) break;
    const n = notes.shift();
    notes.push(n+12);
    notes.sort((a,b)=>a-b);
  }
  return notes;
}

// Find chords matching selected pcs (simple subset match)
function findMatchingChords(selectedPcs, rootPcHint=null){
  const set = new Set(selectedPcs);
  const results = [];

  for(let root=0; root<12; root++){
    if(rootPcHint!==null && root !== rootPcHint) continue;

    for(const q of CHORD_QUALITIES){
      const pcs = q.intervals.map(iv => (root + (iv%12))%12);
      const chordSet = new Set(pcs);

      // match if selected subset of chord (or equal)
      let ok = true;
      for(const spc of set){
        if(!chordSet.has(spc)){ ok=false; break; }
      }
      if(!ok) continue;

      // score: prefer tighter matches (more notes matched)
      const score = set.size / chordSet.size;
      results.push({
        rootPc: root,
        qualityId: q.id,
        qualityLabel: q.label,
        intervals: q.intervals,
        degrees: q.degrees,
        score
      });
    }
  }

  results.sort((a,b)=> (b.score-a.score) || (a.intervals.length-b.intervals.length));
  return results.slice(0, 40);
}

function buildChordName(rootPc, preferFlats, qualityId){
  const base = pretty(nameFromPc(rootPc, preferFlats));
  const map = {
    "maj":"", "min":"m", "dim":"dim", "aug":"aug",
    "7":"7","maj7":"maj7","m7":"m7","mMaj7":"mMaj7","dim7":"dim7","m7b5":"m7b5",
    "6":"6","m6":"m6","9":"9","maj9":"maj9","m9":"m9","11":"11","13":"13"
  };
  return base + (map[qualityId] ?? qualityId);
}

/* =========================
   AUDIO (WebAudio)
========================= */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if(audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}

function playTone(midi, when=0, dur=0.6){
  const ctx = ensureAudio();
  const t0 = ctx.currentTime + when;

  const freq = 440 * Math.pow(2, (midi-69)/12);

  // simple piano-ish: sine + triangle + quick attack
  const o1 = ctx.createOscillator();
  const o2 = ctx.createOscillator();
  o1.type = "sine";
  o2.type = "triangle";
  o1.frequency.value = freq;
  o2.frequency.value = freq;

  const g = ctx.createGain();
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(0.35, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

  // mild lowpass
  const f = ctx.createBiquadFilter();
  f.type = "lowpass";
  f.frequency.setValueAtTime(4200, t0);

  o1.connect(f);
  o2.connect(f);
  f.connect(g);
  g.connect(ctx.destination);

  o1.start(t0); o2.start(t0);
  o1.stop(t0+dur+0.05); o2.stop(t0+dur+0.05);
}

function playChordMidis(midis, mode){
  if(!midis.length) return;
  if(mode==="once"){
    midis.forEach((m,i)=>playTone(m, i*0.0, 0.65));
  }else if(mode==="asc"){
    midis.slice().sort((a,b)=>a-b).forEach((m,i)=>playTone(m, i*0.12, 0.6));
  }else{
    midis.slice().sort((a,b)=>b-a).forEach((m,i)=>playTone(m, i*0.12, 0.6));
  }
}

/* =========================
   STATE + UI
========================= */
const els = {
  tabs: [...document.querySelectorAll(".tab")],
  search: document.getElementById("searchInput"),
  clearBtn: document.getElementById("clearBtn"),
  rootLabel: document.getElementById("rootLabel"),
  rootTrack: document.getElementById("rootTrack"),
  leftList: document.getElementById("leftList"),
  bigChord: document.getElementById("bigChord"),
  legacyLine: document.getElementById("legacyLine"),
  degOut: document.getElementById("degOut"),
  notesOut: document.getElementById("notesOut"),
  modeOut: document.getElementById("modeOut"),
  invBtns: document.getElementById("invBtns"),
  playMode: document.getElementById("playMode"),
  playBtn: document.getElementById("playBtn"),
  kbdInner: document.getElementById("kbdInner"),
  kbd: document.getElementById("kbd"),
  toggleFavBtn: document.getElementById("toggleFavBtn"),
  favBtn: document.getElementById("favBtn"),
  themeBtn: document.getElementById("themeBtn"),
  modalBackdrop: document.getElementById("modalBackdrop"),
  favList: document.getElementById("favList"),
  favCloseBtn: document.getElementById("favCloseBtn"),
  favEditBtn: document.getElementById("favEditBtn"),
  removeAllBtn: document.getElementById("removeAllBtn"),
  removeSelectedBtn: document.getElementById("removeSelectedBtn"),
};

let currentTab = "root";
let selectedRootPc = 0;
let preferFlats = true;
let currentParsed = parseChordInput("Cm") || null;
let inversion = 0;
let playMode = "once";
let pianoSelectedPcs = []; // in Piano mode
let favorites = loadFavorites();
let favEditMode = false;

function saveFavorites(){
  localStorage.setItem("chords_favorites_v1", JSON.stringify(favorites));
}
function loadFavorites(){
  try{
    const s = localStorage.getItem("chords_favorites_v1");
    if(!s) return [];
    const arr = JSON.parse(s);
    if(Array.isArray(arr)) return arr;
    return [];
  }catch{ return []; }
}
function isFav(modernName){
  return favorites.some(x=>x.modernName===modernName);
}

function setTheme(){
  const theme = document.body.getAttribute("data-theme");
  document.body.setAttribute("data-theme", theme==="light" ? "dark":"light");
}
els.themeBtn.addEventListener("click", setTheme);

function openFavModal(){
  renderFavorites();
  els.modalBackdrop.style.display = "flex";
}
function closeFavModal(){
  els.modalBackdrop.style.display = "none";
  favEditMode = false;
  els.favEditBtn.textContent = "Edit";
  els.removeSelectedBtn.style.display = "none";
  renderFavorites();
}
els.favBtn.addEventListener("click", openFavModal);
els.favCloseBtn.addEventListener("click", closeFavModal);
els.modalBackdrop.addEventListener("click", (e)=>{
  if(e.target === els.modalBackdrop) closeFavModal();
});
els.favEditBtn.addEventListener("click", ()=>{
  favEditMode = !favEditMode;
  els.favEditBtn.textContent = favEditMode ? "Done" : "Edit";
  els.removeSelectedBtn.style.display = favEditMode ? "inline-block" : "none";
  renderFavorites();
});
els.removeAllBtn.addEventListener("click", ()=>{
  favorites = [];
  saveFavorites();
  renderFavorites();
  renderFavButton();
});
els.removeSelectedBtn.addEventListener("click", ()=>{
  const checks = [...els.favList.querySelectorAll("input[type=checkbox]:checked")];
  const toRemove = new Set(checks.map(c=>c.value));
  favorites = favorites.filter(f=>!toRemove.has(f.modernName));
  saveFavorites();
  renderFavorites();
  renderFavButton();
});

function renderFavorites(){
  els.favList.innerHTML = "";
  if(!favorites.length){
    els.favList.innerHTML = `<div class="tiny">No favorites yet. Tap â˜… Favorite on a chord.</div>`;
    return;
  }
  for(const f of favorites){
    const div = document.createElement("div");
    div.className = "favRow";
    div.innerHTML = `
      <div style="display:flex; align-items:center; gap:10px;">
        ${favEditMode ? `<input class="chk" type="checkbox" value="${f.modernName}">` : ``}
        <div>
          <div style="font-weight:1000">${f.modernName}</div>
          <div class="tiny">Legacy: ${f.legacyName || f.modernName}</div>
        </div>
      </div>
      <button class="btn">Open</button>
    `;
    div.querySelector("button").addEventListener("click", ()=>{
      applyChord(parseChordInput(f.modernName) || parseChordInput(f.legacyName));
      closeFavModal();
    });
    els.favList.appendChild(div);
  }
}

function renderFavButton(){
  if(!currentParsed){
    els.toggleFavBtn.textContent = "â˜… Favorite";
    return;
  }
  els.toggleFavBtn.textContent = isFav(currentParsed.modernName) ? "â˜… Favorited" : "â˜… Favorite";
}

els.toggleFavBtn.addEventListener("click", ()=>{
  if(!currentParsed) return;
  const exists = isFav(currentParsed.modernName);
  if(exists){
    favorites = favorites.filter(x=>x.modernName !== currentParsed.modernName);
  }else{
    favorites.unshift({
      modernName: currentParsed.modernName,
      legacyName: currentParsed.legacyName
    });
  }
  saveFavorites();
  renderFavButton();
});

/* Root scroller */
function renderRootTrack(){
  els.rootTrack.innerHTML="";
  for(let pc=0; pc<12; pc++){
    const btn = document.createElement("div");
    btn.className="rootItem" + (pc===selectedRootPc ? " active":"");
    btn.textContent = pretty(nameFromPc(pc, true)); // show flats in slider like screenshot (Db, Eb...)
    btn.addEventListener("click", ()=>{
      selectedRootPc = pc;
      els.rootLabel.textContent = pretty(nameFromPc(pc,true));
      renderRootTrack();
      if(currentTab==="root"){
        renderChordListForRoot();
      }else{
        // in piano tab, hint root to matcher
        renderPianoMatchList();
      }
    });
    els.rootTrack.appendChild(btn);
  }
}

/* Left list rendering */
function renderChordListForRoot(query=""){
  els.leftList.innerHTML = "";
  const prefer = true; // show flats in UI
  const rows = [];

  // Build a rich list for the chosen root
  for(const q of CHORD_QUALITIES){
    const name = buildChordName(selectedRootPc, prefer, q.id);
    rows.push({
      modernName:name,
      legacyName:name,
      parsed:{
        rootPc:selectedRootPc,
        preferFlats:prefer,
        qualityId:q.id,
        qualityLabel:q.label,
        intervals:q.intervals,
        degrees:q.degrees,
        legacyName:name,
        modernName:name
      }
    });
  }

  let filtered = rows;
  const q = (query||"").trim().toLowerCase();
  if(q){
    filtered = rows.filter(r=>r.modernName.toLowerCase().includes(q) || (r.legacyName||"").toLowerCase().includes(q));
  }

  for(const r of filtered){
    const div = document.createElement("div");
    div.className = "row" + (currentParsed && currentParsed.modernName===r.parsed.modernName ? " active":"");
    div.innerHTML = `
      <div>
        <div class="name">${r.modernName}</div>
        <div class="sub">${r.parsed.qualityLabel}</div>
      </div>
      <div class="miniKeys"></div>
    `;
    // mini marks
    const pcs = chordNotesFromParsed(r.parsed);
    const mk = div.querySelector(".miniKeys");
    pcs.forEach((pc)=>{
      // simple mapping into bar
      const x = (pc/12)*120 + 5;
      const m = document.createElement("div");
      m.className="miniMark";
      m.style.left = `${x}px`;
      m.style.height = `${18 + (pc%3)*4}px`;
      mk.appendChild(m);
    });

    div.addEventListener("click", ()=>{
      applyChord(r.parsed);
      // on iPad: remove keyboard focus
      els.search.blur();
    });
    els.leftList.appendChild(div);
  }
}

function renderPianoMatchList(){
  // in piano mode, left list shows matching chords to selected pcs
  els.leftList.innerHTML = "";
  if(pianoSelectedPcs.length===0){
    els.leftList.innerHTML = `<div class="tiny">Tap piano keys to select notes. Matching chords will appear here.</div>`;
    return;
  }
  const matches = findMatchingChords(pianoSelectedPcs, selectedRootPc);
  if(!matches.length){
    els.leftList.innerHTML = `<div class="tiny">No matches found.</div>`;
    return;
  }
  for(const m of matches){
    const modernName = buildChordName(m.rootPc, true, m.qualityId);
    const parsed = {
      rootPc:m.rootPc, preferFlats:true,
      qualityId:m.qualityId, qualityLabel:m.qualityLabel,
      intervals:m.intervals, degrees:m.degrees,
      legacyName:modernName, modernName
    };
    const div = document.createElement("div");
    div.className = "row" + (currentParsed && currentParsed.modernName===modernName ? " active":"");
    div.innerHTML = `
      <div>
        <div class="name">${modernName}</div>
        <div class="sub">${m.qualityLabel} Â· match ${Math.round(m.score*100)}%</div>
      </div>
      <div class="miniKeys"></div>
    `;
    const mk = div.querySelector(".miniKeys");
    chordNotesFromParsed(parsed).forEach((pc)=>{
      const x = (pc/12)*120 + 5;
      const mm = document.createElement("div");
      mm.className="miniMark";
      mm.style.left = `${x}px`;
      mm.style.height = `${18 + (pc%3)*4}px`;
      mk.appendChild(mm);
    });
    div.addEventListener("click", ()=>{
      applyChord(parsed);
      els.search.blur();
    });
    els.leftList.appendChild(div);
  }
}

/* Apply chord to right panel + keyboard */
function applyChord(parsed){
  if(!parsed) return;
  currentParsed = parsed;
  inversion = 0;
  setInvButtons();
  renderRight();
  renderChordKeyboard();
  renderChordListForRoot(els.search.value || "");
  renderFavButton();
}

function setInvButtons(){
  [...els.invBtns.querySelectorAll("button")].forEach(b=>{
    b.classList.toggle("active", Number(b.dataset.inv)===inversion);
  });
}
els.invBtns.addEventListener("click",(e)=>{
  const b = e.target.closest("button");
  if(!b) return;
  inversion = Number(b.dataset.inv);
  setInvButtons();
  renderRight();
  renderChordKeyboard();
});

els.playMode.addEventListener("click",(e)=>{
  const b = e.target.closest("button");
  if(!b) return;
  playMode = b.dataset.play;
  [...els.playMode.querySelectorAll("button")].forEach(x=>x.classList.toggle("active", x===b));
});

els.playBtn.addEventListener("click", ()=>{
  if(!currentParsed) return;
  const midis = invertedMidiNotes(currentParsed, 48, inversion);
  playChordMidis(midis, playMode);
});

function renderRight(){
  if(!currentParsed) return;
  els.bigChord.textContent = currentParsed.modernName;
  els.legacyLine.textContent = `Legacy: ${currentParsed.legacyName} | Modern: ${currentParsed.modernName}`;
  els.degOut.textContent = currentParsed.degrees.join(", ");
  // show note names
  const pcs = chordNotesFromParsed(currentParsed);
  const notes = pcs.map(pc => pretty(nameFromPc(pc, true)));
  els.notesOut.textContent = notes.join(", ");
  els.modeOut.textContent = currentParsed.qualityLabel;
}

/* Tabs */
function setTab(t){
  currentTab = t;
  els.tabs.forEach(x=>x.classList.toggle("active", x.dataset.tab===t));
  if(t==="root"){
    document.getElementById("rootScroller").style.display = "";
    renderChordListForRoot(els.search.value||"");
    els.leftHint.textContent = "Type + Enter to search";
  }else if(t==="piano"){
    document.getElementById("rootScroller").style.display = "";
    renderPianoMatchList();
    els.leftHint.textContent = "Tap keys to detect chords";
  }else{
    document.getElementById("rootScroller").style.display = "none";
    els.leftList.innerHTML = `<div class="tiny">Staff view is a placeholder here. If you want real notation rendering, we can add it next.</div>`;
  }
}
els.tabs.forEach(b=>b.addEventListener("click", ()=>setTab(b.dataset.tab)));

/* Search */
function doSearch(){
  const raw = els.search.value.trim();
  if(!raw){
    // reset list
    if(currentTab==="root") renderChordListForRoot("");
    if(currentTab==="piano") renderPianoMatchList();
    return;
  }
  const parsed = parseChordInput(raw);
  if(parsed){
    // sync root scroller
    selectedRootPc = parsed.rootPc;
    preferFlats = parsed.preferFlats;
    els.rootLabel.textContent = pretty(nameFromPc(selectedRootPc, true));
    renderRootTrack();
    applyChord(parsed);
  }else{
    // fallback: filter list
    if(currentTab==="root") renderChordListForRoot(raw);
    if(currentTab==="piano") renderPianoMatchList();
  }
}
els.search.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    doSearch();
    // close iPad keyboard
    els.search.blur();
  }
});
els.search.addEventListener("input", ()=>{
  if(currentTab==="root") renderChordListForRoot(els.search.value||"");
  if(currentTab==="piano") renderPianoMatchList();
});
els.clearBtn.addEventListener("click", ()=>{
  els.search.value="";
  els.search.blur();
  if(currentTab==="root") renderChordListForRoot("");
  if(currentTab==="piano") renderPianoMatchList();
});

/* =========================
   PIANO RENDER
========================= */
const WHITE_ORDER = ["C","D","E","F","G","A","B"];
const BLACKS = new Set(["C#","D#","F#","G#","A#"]);

function renderChordKeyboard(){
  // single chord displayed, bubbles avoid collision on black neighbors
  els.kbdInner.innerHTML = "";

  // Build an 2-octave keyboard: C3..B4 (24 semis) + a bit
  const startMidi = 48; // C3
  const keys = [];
  for(let i=0;i<28;i++){
    keys.push(startMidi+i);
  }

  // white keys positions
  const whiteMidis = keys.filter(m=>{
    const name = NOTE_NAMES_SHARP[m%12];
    return !BLACKS.has(name);
  });

  const whiteW = 52;
  const whiteH = 230;
  const blackW = 34;
  const blackH = 140;

  const totalW = whiteMidis.length * whiteW;
  els.kbdInner.style.width = totalW+"px";
  els.kbdInner.style.height = whiteH+"px";

  const midiToX = new Map();
  let wIndex=0;

  // draw whites
  for(const m of keys){
    const name = NOTE_NAMES_SHARP[m%12];
    if(BLACKS.has(name)) continue;
    const x = wIndex*whiteW;
    midiToX.set(m, x);
    const k = document.createElement("div");
    k.className="whiteKey";
    k.style.left = x+"px";
    k.style.width = whiteW+"px";
    k.style.height = whiteH+"px";

    const hit = document.createElement("div");
    hit.className="keyHit";
    hit.addEventListener("click", ()=>onKeyPress(m));
    k.appendChild(hit);

    // octave labels like C4 C5
    if(name==="C"){
      const lbl = document.createElement("div");
      lbl.style.position="absolute";
      lbl.style.bottom="10px";
      lbl.style.left="10px";
      lbl.style.fontWeight="1000";
      lbl.style.color="rgba(0,0,0,.35)";
      lbl.textContent = "C"+Math.floor(m/12 - 1);
      k.appendChild(lbl);
    }

    els.kbdInner.appendChild(k);
    wIndex++;
  }

  // draw blacks
  wIndex=0;
  for(const m of keys){
    const name = NOTE_NAMES_SHARP[m%12];
    if(BLACKS.has(name)){
      // black sits between adjacent whites. Find left white midi:
      // for C# it's after C; D# after D; F# after F; G# after G; A# after A
      // we can derive by subtracting 1 semitone until white
      let left = m-1;
      while(left>=keys[0] && BLACKS.has(NOTE_NAMES_SHARP[left%12])) left--;
      const leftX = midiToX.get(left);
      if(leftX===undefined) continue;

      const x = leftX + whiteW - (blackW/2);
      const k = document.createElement("div");
      k.className="blackKey";
      k.style.left = x+"px";
      k.style.width = blackW+"px";
      k.style.height = blackH+"px";

      const hit = document.createElement("div");
      hit.className="keyHit";
      hit.addEventListener("click", ()=>onKeyPress(m));
      k.appendChild(hit);

      els.kbdInner.appendChild(k);
      midiToX.set(m, x + blackW/2);
    }
  }

  // bubbles for chord notes
  if(currentParsed){
    const midis = invertedMidiNotes(currentParsed, 48, inversion);
    // place bubbles; if black neighbors collide, stagger Y
    const used = [];
    for(const midi of midis){
      const pc = midi%12;
      const n = pretty(nameFromPc(pc, true));
      const sharpName = NOTE_NAMES_SHARP[pc];
      const isBlack = BLACKS.has(sharpName);

      // find x for that midi by matching pitch class nearest on keyboard
      // choose a midi in keys with same pc (prefer exact midi if in range)
      let target = keys.find(x=>x===midi) ?? keys.find(x=>(x%12)===pc) ?? midi;
      let x = midiToX.get(target);
      if(x===undefined){
        // fallback: approximate from first matching white
        x = 20;
      }

      const b = document.createElement("div");
      b.className="bubble";
      b.textContent = n;

      // collision avoidance: if another bubble too close, offset
      let y = isBlack ? 58 : 150;
      for(const u of used){
        const dx = Math.abs(u.x - x);
        if(dx < 40){
          y = u.y - 52; // stack upward
        }
      }
      used.push({x,y});

      b.style.left = (x - 22)+"px";
      b.style.top = y+"px";
      els.kbdInner.appendChild(b);
    }
  }

  // autoscroll to show chord area center
  setTimeout(()=>{
    const bubbles = [...els.kbdInner.querySelectorAll(".bubble")];
    if(!bubbles.length) return;
    const xs = bubbles.map(b=>b.getBoundingClientRect().left);
    const mid = (Math.min(...xs)+Math.max(...xs))/2;
    // scroll container so mid is near center
    const rect = els.kbd.getBoundingClientRect();
    const desired = mid - rect.left - rect.width/2;
    els.kbd.scrollLeft += desired;
  }, 60);
}

function onKeyPress(midi){
  // unlock audio by user gesture
  ensureAudio();
  playTone(midi, 0, 0.55);

  if(currentTab!=="piano"){
    // in root tab we just audition
    return;
  }

  const pc = midi%12;
  const idx = pianoSelectedPcs.indexOf(pc);
  if(idx>=0) pianoSelectedPcs.splice(idx,1);
  else pianoSelectedPcs.push(pc);

  // Update left list with matches
  renderPianoMatchList();
}

/* =========================
   INIT
========================= */
(function init(){
  // root scroller start
  selectedRootPc = 0;
  els.rootLabel.textContent = "C";
  renderRootTrack();

  // default chord
  applyChord(parseChordInput("Cm"));

  // initial list
  renderChordListForRoot("");

  // set tab root
  setTab("root");

  // render favorites state
  renderFavButton();

  // prevent iOS zoom on focus: keep font >= 16px already
})();
</script>
</body>
</html>
